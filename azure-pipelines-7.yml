trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: Diagnose
  jobs:
  - job: DebugMaven
    steps:
    - checkout: self
    
    - powershell: |
        Write-Host "================== DIAGNOSTICS =================="
        
        # 1. Проверяем Maven
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        Write-Host "1. Maven version:"
        mvn --version
        
        # 2. Проверяем структуру проекта
        Write-Host "`n2. Project structure:"
        Get-ChildItem -Recurse -Depth 3 | Select-Object FullName
        
        # 3. Проверяем pom.xml
        Write-Host "`n3. Checking pom.xml:"
        if (Test-Path "pom.xml") {
            Write-Host "pom.xml exists"
            # Показываем содержимое pom.xml
            Get-Content pom.xml
        } else {
            Write-Host "ERROR: pom.xml not found!"
            # Ищем любые pom.xml
            Get-ChildItem -Filter "pom.xml" -Recurse
        }
        
        # 4. Проверяем есть ли Java исходники
        Write-Host "`n4. Looking for Java source files:"
        $javaFiles = Get-ChildItem -Filter "*.java" -Recurse
        if ($javaFiles.Count -gt 0) {
            Write-Host "Found $($javaFiles.Count) Java files:"
            $javaFiles | Select-Object -First 5 | ForEach-Object { Write-Host "  - $($_.FullName)" }
        } else {
            Write-Host "WARNING: No Java source files found!"
        }
        
        # 5. Пробуем собрать с максимальной детализацией
        Write-Host "`n5. Trying Maven build with verbose output:"
        mvn clean compile -X  # -X для максимальной детализации
        
        Write-Host "`n6. Checking if target directory was created:"
        if (Test-Path "target") {
            Write-Host "target directory exists"
            Get-ChildItem -Path "target" -Recurse | Format-Table FullName, Length
        } else {
            Write-Host "ERROR: target directory NOT created"
        }
        
        # 6. Пробуем создать JAR
        Write-Host "`n7. Trying to create JAR:"
        mvn package -DskipTests -e  # -e для показа ошибок
        
        Write-Host "`n8. Final check for JAR files:"
        $jarFiles = Get-ChildItem -Filter "*.jar" -Recurse
        if ($jarFiles.Count -gt 0) {
            Write-Host "SUCCESS: Found $($jarFiles.Count) JAR file(s):"
            $jarFiles | ForEach-Object { 
                Write-Host "  - $($_.FullName) ($($_.Length) bytes)"
                # Показываем содержимое JAR
                Write-Host "    Contents:"
                try {
                    & "C:\Program Files\Java\jdk-*\bin\jar.exe" tf $_.FullName | Select-Object -First 5
                } catch {
                    Write-Host "    (Cannot list JAR contents)"
                }
            }
        } else {
            Write-Host "ERROR: No JAR files created!"
            Write-Host "Checking what's in target/classes:"
            if (Test-Path "target\classes") {
                Get-ChildItem -Path "target\classes" -Recurse | Select-Object -First 10
            }
        }
      displayName: 'Diagnose Maven Build'