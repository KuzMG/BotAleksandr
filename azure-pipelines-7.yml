trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: BuildAndRun
  displayName: 'Build and Run'
  jobs:
  - job: Execute
    steps:
    - checkout: self
    
    - powershell: |
        Write-Host "=== Step 1: Setup Maven ==="
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        
        Write-Host "=== Step 2: Build ==="
        mvn clean package -DskipTests
        
        Write-Host "=== Step 3: Find JAR ==="
        # Ищем JAR в target
        $jarFiles = Get-ChildItem -Path "target" -Filter "*.jar" -File
        
        if ($jarFiles.Count -eq 0) {
            Write-Error "No JAR files in target directory!"
            Write-Host "Checking entire project..."
            Get-ChildItem -Path . -Recurse | Format-Table FullName, Length
            exit 1
        }
        
        Write-Host "Found $($jarFiles.Count) JAR file(s):"
        $jarFiles | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)"
        }
        
        # Выбираем основной JAR (не sources/javadoc/original)
        $mainJar = $jarFiles | 
                   Where-Object { $_.Name -notmatch "(sources|javadoc|original)" } | 
                   Select-Object -First 1
        
        if (-not $mainJar) {
            $mainJar = $jarFiles[0]
        }
        
        Write-Host "=== Step 4: Run $($mainJar.Name) ==="
        Write-Host "Path: $($mainJar.FullName)"
        Write-Host "Size: $([math]::Round($mainJar.Length/1KB, 2)) KB"
        Write-Host "========================================"
        
        # Запускаем приложение
        java -jar $mainJar.FullName
      displayName: 'Build and Run Java Bot'