trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: BuildAndRun
  displayName: 'Build and Run'
  jobs:
  - job: Execute
    timeoutInMinutes: 30  # Таймаут 30 минут
    steps:
    - checkout: self
    
    - powershell: |
        Write-Host "=== Step 1: Setup Environment ==="
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        
        Write-Host "`n=== Step 2: Build Project ==="
        # Собираем с выводом логов в файл
        mvn clean package -DskipTests 2>&1 | Tee-Object -FilePath "maven-build.log"
        
        Write-Host "`n=== Step 3: Check Build Results ==="
        if (Test-Path "maven-build.log") {
            Write-Host "Last 20 lines of build log:"
            Get-Content "maven-build.log" | Select-Object -Last 20
        }
        
        if (-not (Test-Path "target")) {
            Write-Error "Build failed - target directory not created"
            exit 1
        }
        
        Write-Host "`n=== Step 4: Find JAR File ==="
        $jarFiles = Get-ChildItem -Path "target" -Filter "*.jar" -File
        
        if ($jarFiles.Count -eq 0) {
            Write-Error "No JAR files created!"
            Write-Host "Target directory contents:"
            Get-ChildItem -Path "target" -Recurse
            exit 1
        }
        
        Write-Host "Found $($jarFiles.Count) JAR file(s):"
        $jarFiles | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)"
        }
        
        # Выбираем JAR для запуска
        $mainJar = $jarFiles | 
                   Where-Object { $_.Name -notlike "*-original.*" } | 
                   Select-Object -First 1
        
        if (-not $mainJar) {
            $mainJar = $jarFiles[0]
        }
        
        Write-Host "`n=== Step 5: Run Application ==="
        Write-Host "JAR: $($mainJar.FullName)"
        Write-Host "Size: $([math]::Round($mainJar.Length/1KB, 2)) KB"
        Write-Host "========================================"
        
        # Запускаем приложение с логированием
        $logFile = "application.log"
        Write-Host "Output will be logged to: $logFile"
        
        # Запускаем в фоновом режиме с логированием
        $process = Start-Process java -ArgumentList "-jar `"$($mainJar.FullName)`"" `
                  -NoNewWindow -PassThru -RedirectStandardOutput $logFile -RedirectStandardError $logFile
        
        Write-Host "Application started with PID: $($process.Id)"
        Write-Host "Waiting for 30 seconds to see initial output..."
        
        # Ждем и показываем начало логов
        Start-Sleep -Seconds 30
        
        if (Test-Path $logFile) {
            Write-Host "`n=== Application Log (first 50 lines) ==="
            Get-Content $logFile | Select-Object -First 50
        } else {
            Write-Host "Log file not created yet"
        }
        
        # Проверяем, жив ли процесс
        if (Get-Process -Id $process.Id -ErrorAction SilentlyContinue) {
            Write-Host "`nApplication is still running. Process will continue in background."
            Write-Host "To stop manually, use: taskkill /PID $($process.Id) /F"
        } else {
            Write-Host "`nApplication has stopped."
        }
      displayName: 'Build and Run Java Bot'