trigger:
- main

pool:
  name: 'Pool'

steps:
- checkout: self

- powershell: |
    # Настраиваем Maven
    $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
    $env:PATH = "$mavenPath;" + $env:PATH
    
    Write-Host "=== Step 1: Build project ==="
    mvn clean package -DskipTests
    
    Write-Host "`n=== Step 2: Find the JAR ==="
    # Ищем ВСЕ JAR файлы
    $allJars = Get-ChildItem -Path . -Filter "*.jar" -Recurse -File
    
    if ($allJars.Count -eq 0) {
        Write-Error "No JAR files created!"
        Write-Host "Checking target directory..."
        if (Test-Path "target") {
            Get-ChildItem -Path "target" -Recurse
        }
        exit 1
    }
    
    Write-Host "Found $($allJars.Count) JAR file(s):"
    $allJars | ForEach-Object {
        Write-Host "  - $($_.FullName) ($([math]::Round($_.Length/1KB, 2)) KB)"
    }
    
    # Выбираем основной JAR (из target, не sources/javadoc)
    $mainJar = $allJars | 
               Where-Object { 
                   $_.DirectoryName -like "*target*" -and
                   $_.Name -notmatch "(sources|javadoc|original|-tests\.jar$)"
               } | 
               Select-Object -First 1
    
    if (-not $mainJar) {
        Write-Host "No main JAR found, using first JAR"
        $mainJar = $allJars[0]
    }
    
    Write-Host "`n=== Step 3: Running $($mainJar.Name) ==="
    Write-Host "Full path: $($mainJar.FullName)"
    Write-Host "Size: $([math]::Round($mainJar.Length/1KB, 2)) KB"
    Write-Host "========================================"
    
    # Запускаем
    java -jar $mainJar.FullName
  displayName: 'Build and Run Directly'