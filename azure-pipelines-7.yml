trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    - checkout: self
    
    - powershell: |
        # Настройка Maven
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        
        # Сборка
        mvn clean package -DskipTests
        
        # Проверка
        $jarFile = Get-ChildItem -Path "target" -Filter "*.jar" -File | Select-Object -First 1
        if (-not $jarFile) {
            Write-Error "JAR not created!"
            exit 1
        }
        
        Write-Host "JAR created: $($jarFile.Name)"
        
        # Копируем JAR в специальную папку для артефактов
        $artifactDir = "$(Pipeline.Workspace)/artifacts"
        New-Item -ItemType Directory -Force -Path $artifactDir
        Copy-Item -Path $jarFile.FullName -Destination $artifactDir -Force
      displayName: 'Build JAR'
    
    # Публикуем как pipeline artifact (не build artifact)
    - task: PublishPipelineArtifact@1
      inputs:
        targetPath: '$(Pipeline.Workspace)/artifacts'
        artifact: 'java-bot'
        publishLocation: 'pipeline'

- stage: Run
  dependsOn: Build
  jobs:
  - job: Run
    steps:
    # Скачиваем pipeline artifact
    - task: DownloadPipelineArtifact@2
      inputs:
        artifact: 'java-bot'
        path: '$(Pipeline.Workspace)/downloaded'
    
    - powershell: |
        Write-Host "=== Downloaded files ==="
        Get-ChildItem -Path "$(Pipeline.Workspace)/downloaded" -Recurse
        
        $jarFile = Get-ChildItem -Path "$(Pipeline.Workspace)/downloaded" -Filter "*.jar" -File | Select-Object -First 1
        
        if ($jarFile) {
            Write-Host "Running: $($jarFile.FullName)"
            java -jar $jarFile.FullName
        } else {
            Write-Error "JAR not found in downloaded artifacts"
        }
      displayName: 'Run Bot'