trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: Build
  displayName: 'üì¶ Build'
  jobs:
  - job: BuildJar
    steps:
    - checkout: self
    
    - powershell: |
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Maven
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        
        Write-Host "Building with Maven..."
        mvn clean package -DskipTests
        
        # –ù–∞—Ö–æ–¥–∏–º JAR
        $jarFile = Get-ChildItem -Path "target" -Filter "*.jar" -File | 
                   Where-Object { $_.Name -notlike "*-original.*" } | 
                   Select-Object -First 1
        
        if (-not $jarFile) {
            Write-Error "JAR not created!"
            exit 1
        }
        
        Write-Host "JAR created: $($jarFile.Name)"
        
        # –ö–æ–ø–∏—Ä—É–µ–º JAR –≤ –ø–∞–ø–∫—É –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        $artifactDir = "$(Pipeline.Workspace)/artifacts"
        New-Item -ItemType Directory -Force -Path $artifactDir
        Copy-Item -Path $jarFile.FullName -Destination $artifactDir -Force
        
        Write-Host "Copied to: $artifactDir"
      displayName: 'Build JAR'
    
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact'
      inputs:
        targetPath: '$(Pipeline.Workspace)/artifacts'
        artifact: 'java-bot'
        publishLocation: 'pipeline'

- stage: Run
  displayName: 'üöÄ Run'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: RunBot
    steps:
    # –°–∫–∞—á–∏–≤–∞–µ–º pipeline artifact
    - task: DownloadPipelineArtifact@2
      displayName: 'Download JAR'
      inputs:
        artifact: 'java-bot'
        path: '$(System.DefaultWorkingDirectory)/downloaded'
    
    - powershell: |
        Write-Host "=== Current directory ==="
        Write-Host "$(Get-Location)"
        
        Write-Host "`n=== Looking for downloaded files ==="
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —è–≤–Ω–æ–º –ø—É—Ç–∏
        $downloadPath = "$(System.DefaultWorkingDirectory)/downloaded"
        Write-Host "Download path: $downloadPath"
        
        if (Test-Path $downloadPath) {
            Write-Host "Files in download path:"
            Get-ChildItem -Path $downloadPath -Recurse
            
            $jarFile = Get-ChildItem -Path $downloadPath -Filter "*.jar" -Recurse -File | Select-Object -First 1
        } else {
            Write-Host "Download path not found, searching everywhere..."
            $jarFile = Get-ChildItem -Path . -Filter "*.jar" -Recurse -File | Select-Object -First 1
        }
        
        if ($jarFile) {
            Write-Host "`n=== Found JAR: $($jarFile.FullName) ==="
            Write-Host "Starting application..."
            Write-Host "========================================"
            java -jar $jarFile.FullName
        } else {
            Write-Error "JAR not found after download!"
            Write-Host "All files in current directory:"
            Get-ChildItem -Path . -Recurse | Select-Object FullName
        }
      displayName: 'Run Bot'