trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    - checkout: self
    
    - powershell: |
        # Устанавливаем переменные
        $MAVEN_PATH = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$MAVEN_PATH;" + $env:PATH
        
        Write-Host "=== Java Version ==="
        java -version
        
        Write-Host "=== Maven Version ==="
        mvn --version
        
        Write-Host "=== Project Structure ==="
        Get-ChildItem -Recurse -Depth 2
        
        Write-Host "=== Building with Maven ==="
        mvn clean compile package -DskipTests
        
        Write-Host "=== Build Results ==="
        if (Test-Path "target") {
            Get-ChildItem -Path "target" -Recurse | Format-Table Name, Length, LastWriteTime
            
            # Копируем JAR файлы в staging directory
            $stagingDir = "$(Build.ArtifactStagingDirectory)"
            New-Item -ItemType Directory -Force -Path $stagingDir
            
            $jarFiles = Get-ChildItem -Path "target" -Filter "*.jar" -Recurse
            foreach ($jar in $jarFiles) {
                Copy-Item -Path $jar.FullName -Destination $stagingDir -Force
                Write-Host "Copied: $($jar.Name)"
            }
        } else {
            Write-Error "Build failed: target directory not created"
            exit 1
        }
      displayName: 'Build with Maven'
    
    - publish: '$(Build.ArtifactStagingDirectory)'
      artifact: 'java-app'
      displayName: 'Publish JAR'

- stage: Run
  dependsOn: Build
  jobs:
  - job: Run
    steps:
    - download: current
      artifact: 'java-app'
    
    - powershell: |
        Write-Host "=== Finding JAR file ==="
        $jarFile = Get-ChildItem -Path . -Filter "*.jar" -File | Select-Object -First 1
        
        if ($jarFile) {
            Write-Host "Running: $($jarFile.FullName)"
            Write-Host "========================================"
            java -jar $jarFile.FullName
        } else {
            Write-Error "No JAR file found!"
            Get-ChildItem -Path . -Recurse | Format-Table FullName
            exit 1
        }
      displayName: 'Run Application'