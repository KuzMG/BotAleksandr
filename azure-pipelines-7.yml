trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    - checkout: self
    
    - powershell: |
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        
        # Собираем
        mvn clean package -DskipTests
        
        # Сохраняем путь к JAR в переменную
        $jarFile = Get-ChildItem -Path "target" -Filter "*.jar" -File | Select-Object -First 1
        Write-Host "##vso[task.setvariable variable=JAR_PATH;isOutput=true]$($jarFile.FullName)"
        Write-Host "##vso[task.setvariable variable=JAR_NAME;isOutput=true]$($jarFile.Name)"
      displayName: 'Build'
      name: BuildStep

- stage: Run
  dependsOn: Build
  jobs:
  - job: Run
    steps:
    - checkout: self  # Снова чекаутим тот же код
    
    - powershell: |
        # Получаем переменные из предыдущего stage
        $jarPath = "$(BuildStep.JAR_PATH)"
        $jarName = "$(BuildStep.JAR_NAME)"
        
        Write-Host "JAR from previous stage: $jarName"
        
        # Снова собираем (или ищем собранный JAR)
        if (Test-Path $jarPath) {
            Write-Host "JAR exists at: $jarPath"
            java -jar $jarPath
        } else {
            Write-Host "JAR not found, rebuilding..."
            $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
            $env:PATH = "$mavenPath;" + $env:PATH
            
            mvn clean package -DskipTests
            
            $jarFile = Get-ChildItem -Path "target" -Filter "*.jar" -File | Select-Object -First 1
            java -jar $jarFile.FullName
        }
      displayName: 'Run Application'