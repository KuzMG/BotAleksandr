trigger:
- main

pool:
  name: 'Pool'

stages:
- stage: BuildAndRun
  displayName: 'Build and Run'
  jobs:
  - job: Execute
    timeoutInMinutes: 30
    steps:
    - checkout: self
    
    - powershell: |
        Write-Host "=== Step 1: Setup Environment ==="
        $mavenPath = "D:\misha\Desktop\agent\apache-maven-3.9.11\bin"
        $env:PATH = "$mavenPath;" + $env:PATH
        
        Write-Host "`n=== Step 2: Build Project ==="
        mvn clean package -DskipTests
        
        Write-Host "`n=== Step 3: Check Build Results ==="
        if (-not (Test-Path "target")) {
            Write-Error "Build failed - target directory not created"
            exit 1
        }
        
        Write-Host "`n=== Step 4: Find JAR File ==="
        $jarFiles = Get-ChildItem -Path "target" -Filter "*.jar" -File
        
        if ($jarFiles.Count -eq 0) {
            Write-Error "No JAR files created!"
            Get-ChildItem -Path "target" -Recurse
            exit 1
        }
        
        Write-Host "Found $($jarFiles.Count) JAR file(s):"
        $jarFiles | ForEach-Object {
            Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)"
        }
        
        # Выбираем JAR для запуска
        $mainJar = $jarFiles | 
                   Where-Object { $_.Name -notlike "*-original.*" } | 
                   Select-Object -First 1
        
        if (-not $mainJar) {
            $mainJar = $jarFiles[0]
        }
        
        Write-Host "`n=== Step 5: Run Application ==="
        Write-Host "JAR: $($mainJar.FullName)"
        Write-Host "Size: $([math]::Round($mainJar.Length/1KB, 2)) KB"
        Write-Host "========================================"
        
        # Запускаем приложение
        Write-Host "Starting bot..."
        java -jar $mainJar.FullName
        
        Write-Host "Bot has finished execution."
      displayName: 'Build and Run Java Bot'